name: Tree-shake test

on:
  pull_request:

jobs:
  treeshake-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          path: pr-branch

      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          path: target-branch
          ref: ${{ github.base_ref }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.15.1
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'pnpm'
          cache-dependency-path: |
            pr-branch/pnpm-lock.yaml
            target-branch/pnpm-lock.yaml

      - name: Install dependencies (PR branch)
        working-directory: pr-branch
        run: pnpm install

      - name: Install dependencies (target branch)
        working-directory: target-branch
        run: pnpm install

      - name: Run tree-shake test on PR branch
        working-directory: pr-branch
        run: pnpm --filter treeshake-test test

      - name: Run tree-shake test on target branch
        working-directory: target-branch
        run: pnpm --filter treeshake-test test

      - name: Compare results
        run: |
          node pr-branch/apps/treeshake-test/compare-results.ts \
            pr-branch/apps/treeshake-test/results.json \
            target-branch/apps/treeshake-test/results.json \
            > comparison.md

      - name: Upload PR results
        uses: actions/upload-artifact@v4
        with:
          name: pr-results
          path: pr-branch/apps/treeshake-test/results.json

      - name: Upload target results
        uses: actions/upload-artifact@v4
        with:
          name: target-results
          path: target-branch/apps/treeshake-test/results.json

      - name: Upload comparison
        uses: actions/upload-artifact@v4
        with:
          name: comparison
          path: comparison.md

      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ðŸ“Š Bundle Size Comparison\n\n' + comparison
            });
